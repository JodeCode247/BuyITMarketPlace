{% extends "onlineStore/base.html" %}

{% block title %}{{ product.name }} | Buy It Marketplace{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 py-12">
    <nav class="mb-8 flex text-sm text-gray-500 font-medium">
        <a href="{% url 'onlinestore:home' %}" class="hover:text-orange-primary transition">Home</a>
        <span class="mx-2">/</span>
        <span class="text-gray-900 truncate">{{ product.name }}</span>
    </nav>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-12 bg-white p-6 md:p-10 rounded-[2rem] shadow-xl shadow-gray-200/50 border border-gray-100 cart-item" data-product-id="{{ product.id }}">
        
        <div class="space-y-6">
            <div class="main-image bg-gray-50 rounded-3xl overflow-hidden border border-gray-100 flex items-center justify-center p-4">
                <img src="{{ product.image_url }}" alt="{{ product.name }}" id="main-product-image" 
                     class="w-full h-[400px] md:h-[500px] object-contain hover:scale-105 transition-transform duration-500">
            </div>
            
            <div class="thumbnail-images flex gap-4 overflow-x-auto pb-2">
                <img src="{{ product.image_url }}" alt="Main Thumb" 
                     class="active-thumbnail w-20 h-20 rounded-xl object-cover cursor-pointer border-2 border-orange-primary p-1">
                <img src="https://placehold.co/100x100/A0A0A0/FFFFFF?text=View+2" class="w-20 h-20 rounded-xl object-cover cursor-pointer border-2 border-transparent hover:border-orange-100 p-1">
                <img src="https://placehold.co/100x100/B0B0B0/FFFFFF?text=View+3" class="w-20 h-20 rounded-xl object-cover cursor-pointer border-2 border-transparent hover:border-orange-100 p-1">
            </div>
        </div>

        <div class="flex flex-col">
            <div class="mb-6">
                <h1 class="text-3xl md:text-4xl font-black text-gray-900 leading-tight mb-2">{{ product.name }}</h1>
                <div class="flex items-center gap-4">
                    <div class="flex items-center text-orange-primary text-sm">
                        <i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="far fa-star text-gray-300"></i>
                        <span class="ml-2 text-gray-500 font-medium">(124 reviews)</span>
                    </div>
                    <span class="text-xs font-bold uppercase tracking-widest px-3 py-1 bg-green-50 text-green-600 rounded-full">
                        {{ product.category|default:"Verified Item" }}
                    </span>
                </div>
            </div>

            <div class="flex items-baseline gap-4 mb-8">
                <span class="text-4xl font-black text-orange-primary">₦{{ product.price }}</span>
                <span class="item-total-price hidden">₦{{ product.price }}</span>
                <span class="text-sm font-bold text-orange-600 bg-orange-50 px-3 py-1 rounded-full">
                    {{ product.number_available }} units left
                </span>
            </div>

            <div class="mb-8">
                <h3 class="text-sm font-black uppercase tracking-widest text-gray-400 mb-3">Product Description</h3>
                <p class="text-gray-600 leading-relaxed">{{ product.description }}</p>
            </div>

            <div class="space-y-6 mb-10">
               <div class="inline-flex items-center bg-gray-100 rounded-2xl p-1 relative">
                    <button class="qty-btn minus-qty w-10 h-10 flex items-center justify-center font-bold text-xl hover:text-orange-primary transition relative">
                        <span class="btn-text">−</span>
                        <span class="qty-spinner hidden absolute w-4 h-4 border-2 border-orange-primary/30 border-t-orange-primary rounded-full animate-spin"></span>
                    </button>
                    
                    <span id="product-quantity-{{product.id}}" class="qty-value w-12 text-center font-black text-lg">
                        {% if product_cart_item %}{{product_cart_item.quantity}}{% else %}0{% endif %}
                    </span>

                    <button class="qty-btn plus-qty w-10 h-10 flex items-center justify-center font-bold text-xl hover:text-orange-primary transition relative">
                        <span class="btn-text">+</span>
                        <span class="qty-spinner hidden absolute w-4 h-4 border-2 border-orange-primary/30 border-t-orange-primary rounded-full animate-spin"></span>
                    </button>
                </div>
            </div>

            <div class="flex flex-col sm:flex-row gap-4 mb-8">
                {% if product.number_available %}
                <button id="add-to-cart-btn" data-product-id="{{product.id}}"
                        class="flex-1 bg-orange-primary text-white py-4 rounded-2xl font-black text-lg hover-orange transition-all shadow-lg shadow-orange-100 active:scale-95 flex items-center justify-center gap-2">
                    <i class="fas fa-shopping-cart"></i>
                    <span>Add to Cart</span>
                    <span class="button-spinner hidden w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin"></span>
                </button>
                <button class="flex-1 bg-gray-900 text-white py-4 rounded-2xl font-black text-lg hover:bg-black transition-all shadow-lg active:scale-95">
                    Buy Now
                </button>
                {% else %}
                <button disabled class="w-full bg-gray-100 text-gray-400 py-4 rounded-2xl font-black text-lg cursor-not-allowed italic">
                    Currently Out of Stock
                </button>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const productId = "{{ product.id }}";
        const productQuantityDisplay = document.getElementById(`product-quantity-${productId}`);
        const addToCartButton = document.getElementById('add-to-cart-btn');

        if (!addToCartButton) return;

        const spinner = addToCartButton.querySelector('.button-spinner');
        const btnText = addToCartButton.querySelector('span');

        // Thumbnail Click Logic
        const mainImg = document.getElementById('main-product-image');
        document.querySelectorAll('.thumbnail-images img').forEach(thumb => {
            thumb.addEventListener('click', () => {
                mainImg.src = thumb.src;
                document.querySelectorAll('.thumbnail-images img').forEach(t => t.classList.remove('border-orange-primary'));
                thumb.classList.add('border-orange-primary');
            });
        });

        // Add to Cart
        addToCartButton.addEventListener('click', function() {
            const originalText = btnText.innerHTML;
            addToCartButton.disabled = true;
            spinner.classList.remove('hidden');
            spinner.style.display = 'inline-block';
            
            // Reusing addItem from base.html
            addItem(productId, addToCartButton, originalText, spinner);
        });

        // --- QUANTITY BUTTONS LOGIC ---
    document.querySelectorAll('.qty-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const container = this.closest('.cart-item');
            const quantitySpan = container.querySelector('.qty-value');
            const itemSumPriceDisplay = container.querySelector('.item-total-price');
            const spinner = this.querySelector('.qty-spinner');
            const btnText = this.querySelector('.btn-text');
            
            const action = this.classList.contains('plus-qty') ? 'increment' : 'decrement';

            if (action === 'decrement' && parseInt(quantitySpan.textContent) <= 1) {
                showAlert("Minimum quantity is 1", "info");
                return;
            }

            // Start Loading State
            this.disabled = true;
            this.classList.add('opacity-50');
            if(spinner) spinner.classList.remove('hidden');
            if(btnText) btnText.classList.add('hidden');

            updateCartx(action, productId, this, quantitySpan, itemSumPriceDisplay, spinner, btnText);
        });
    });

    function updateCartx(action, productId, buttonElement, quantitySpan, itemSumPriceDisplay, spinner, btnText) {
        fetch('/cart/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ action: action, product_id: productId })
        })
        .then(response => response.json())
        .then(data => {
            // End Loading State
            buttonElement.disabled = false;
            buttonElement.classList.remove('opacity-50');
            if(spinner) spinner.classList.add('hidden');
            if(btnText) btnText.classList.remove('hidden');

            if (data.status === 'success') {
                const newQty = data.new_quantity || data.quantity;
                if (newQty !== undefined) {
                    quantitySpan.textContent = newQty;
                }
                if (itemSumPriceDisplay && data.new_item_sum_price) {
                    itemSumPriceDisplay.textContent = `₦${data.new_item_sum_price}`;
                }
                fetchCartCount(); 
            } else {
                showAlert(data.message || 'Update failed', 'error');
            }
        })
        .catch(error => {
            buttonElement.disabled = false;
            buttonElement.classList.remove('opacity-50');
            if(spinner) spinner.classList.add('hidden');
            if(btnText) btnText.classList.remove('hidden');
            showAlert('Network error. Please try again.', 'error');
        });
    }

     
    });
</script>
{% endblock %}