{% extends "onlineStore/base.html" %}

{% block content %}

<style>
:root {
    --primary: #ff8c00;
    --primary-dark: #e67600;
    --bg: #f7f7f9;
    --card: #ffffff;
    --text: #1f2937;
    --muted: #6b7280;
    --border: #e5e7eb;
    --radius: 14px;
}

* { box-sizing: border-box; }

body {
    font-family: 'Inter', sans-serif;
    background: var(--bg);
    color: var(--text);
}

.checkout-page {
    max-width: 1200px;
    margin: 40px auto;
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 32px;
    padding: 16px;
}

.cart-items, .cart-summary {
    background: var(--card);
    border-radius: var(--radius);
    padding: 24px;
    box-shadow: 0 12px 30px rgba(0,0,0,0.06);
}

h2 { font-size: 1.25rem; font-weight: 700; margin-bottom: 16px; }

.cart-item {
    display: flex;
    justify-content: space-between;
    gap: 16px;
    padding: 16px 0;
    border-bottom: 1px solid var(--border);
}

.cart-item:last-child { border-bottom: none; }

.item-details { display: flex; gap: 12px; }

.item-details img {
    width: 80px; height: 80px;
    border-radius: 10px; object-fit: cover;
}

.item-info h3 { font-size: 0.95rem; font-weight: 600; margin-bottom: 4px; }
.item-info p { font-size: 0.8rem; color: var(--muted); }

.item-actions { text-align: right; min-width: 120px; }
.item-actions p { font-size: 0.85rem; }
.item-actions p:first-child { color: green; font-weight: 600; }

.quantity-control {
    display: inline-flex;
    align-items: center;
    border: 1px solid var(--border);
    border-radius: 10px;
    overflow: hidden;
    margin-top: 6px;
}

.quantity-control button {
    background: #f3f4f6;
    border: none;
    padding: 6px 12px;
    cursor: pointer;
}

/* Spinner Styles */
.spinner {
    display: none; /* Hidden by default */
    width: 12px;
    height: 12px;
    border: 2px solid rgba(0, 0, 0, 0.1);
    border-top: 2px solid var(--primary);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin: 0 auto;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* While loading, hide the text (+ or -) and show the spinner */
.quantity-control button.loading .btn-text {
    display: none;
}

.quantity-control button.loading .spinner {
    display: block;
}

.quantity-control button:disabled {
    opacity: 0.7;
    cursor: not-allowed;
}

.quantity-control span { min-width: 32px; text-align: center; font-weight: 600; }

.checkout-button, .payment-button {
    background: var(--primary);
    color: #fff;
    border: none;
    padding: 14px;
    border-radius: 12px;
    font-weight: 600;
    width: 100%;
    cursor: pointer;
    transition: all 0.2s ease;
}

.checkout-button:hover { background: var(--primary-dark); transform: translateY(-1px); }

.remove-button {
    background: none; border: none;
    color: #dc2626; font-size: 0.8rem;
    cursor: pointer; margin-top: 6px;
}

.summary-details { display: flex; justify-content: space-between; margin-bottom: 16px; font-weight: 600; }

form { display: grid; gap: 12px; }
input, textarea {
    width: 100%; padding: 12px;
    border-radius: 10px; border: 1px solid var(--border);
}

.popup-container {
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.5);
    display: none; align-items: center; justify-content: center;
    z-index: 1000;
}

.popup-content {
    background: #fff; padding: 24px;
    border-radius: 16px; width: 90%; max-width: 340px;
    text-align: center; position: relative;
}

@media (max-width: 900px) {
    .checkout-page { grid-template-columns: 1fr; }
    .cart-item { flex-direction: column; }
    .item-actions { text-align: left; }
}
    /* Add this to your <style> block */
    .checkout-button:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
    }
</style>

<main class="checkout-page">
    <section class="cart-items" id="cart-items-container">
        <h2>My Cart <span id="cart-count-title"></span></h2>
        
        <div id="items-list">
            {% for item in cart_items %}
            <div class="cart-item" data-product-id="{{ item.product.id }}">
                <div class="item-details">
                    <img src="{{item.product.image_url}}" alt="{{item.product.name}}">
                    <div class="item-info">
                        <a href='{% url "onlinestore:products_description" item.product.id %}'><h3>{{item.product.name}}</h3></a>
                        <p>Variation: BLACK</p>
                        <p>{{item.product.number_available}} units left</p>
                        <p>BUY.IT EXPRESS</p>
                    </div>
                </div>
                <div class="item-actions">
                    <p>₦{{item.product.price}}</p>
                    <p class="item-sum-price">₦{{item.sum_price}}</p>
                    <button onclick="delete_cart_item({{item.product.id}})" class="remove-button">Remove</button>
                    <div class="quantity-control">
                            <button class="decrement-button" data-product-id="{{item.product.id}}">
                                <span class="btn-text">-</span>
                                <div class="spinner"></div>
                            </button>
                            <span class="item-quantity">{{item.quantity}}</span>
                            <button class="increment-button" data-product-id="{{item.product.id}}">
                                <span class="btn-text">+</span>
                                <div class="spinner"></div>
                            </button>
                        </div>
                    </div>
              </div>
            {% empty %}
             <div class="col-span-full py-20 text-center">
                <div class="text-gray-400 mb-4">
                    <svg class="mx-auto h-16 w-16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                </div>
                <h3 class="text-xl font-medium text-gray-900"> Cart Empty</h3>
                <a href="/" class="mt-6 inline-block bg-orange-primary text-white px-6 py-2 rounded-full hover-orange">Explore more Products</a>
            </div>
        
            {% endfor %}
        </div>

        {% if cart_items %}
        <button onclick='clearCart()' class="checkout-button" id="clear-cart-btn" style="margin-top: 20px; background: #e7760d;">Clear cart</button>
        {% endif %}
    </section>

    <section class="cart-summary">
        <h2>CART SUMMARY</h2>
        <div class="summary-details">
            <p>Subtotal</p>
            <p id="total-price-display">₦ {{total_price}}</p>
        </div>

        <form method="post" id="checkout-form">
            {% csrf_token %}
            <input type="text" id="name" name="name" placeholder="Full Name" required>
            <input type="email" id="email" name="email" placeholder="Email Address" required>
            <input type="tel" id="phone_number" name="phone_number" placeholder="Phone Number" required pattern="[0-9]{10,15}">
            <input type="text" id="address" name="address" placeholder="Delivery Address" required>
            <input type="text" id="state" name="state" placeholder="State" required>
            <input type="text" id="country" name="country" placeholder="Country" required>
            <textarea id="description" name="description" rows="3" placeholder="Additional notes (Optional)"></textarea>

            <button type="submit" id="payment-options-button" class="checkout-button">
                Checkout (<span id="checkout-btn-price">₦ {{total_price}}</span>)
            </button>
        </form>
    </section>
</main>

<div class="popup-container" id="payment-popup">
    <div class="popup-content">
        <button class="close-button" id="close-popup" style="position: absolute; right: 10px; top: 10px; border: none; background: none; font-size: 20px; cursor: pointer;">&times;</button>
        <h2>Payment Method</h2>
        <button class="payment-button" id="paystack-pay" style="margin-bottom: 10px;">Paystack</button>
        <button class="payment-button" id="card-pay" style="background: #9ca3af; cursor: not-allowed;">Credit Card (Coming Soon)</button>
    </div>
</div>

<script>
    const popupContainer = document.getElementById('payment-popup');
    const totalPriceDisplay = document.getElementById('total-price-display');

    function checkEmptyCart() {
        if (document.querySelectorAll('.cart-item').length === 0) {
            if(document.getElementById('clear-cart-btn')) document.getElementById('clear-cart-btn').remove();
            totalPriceDisplay.textContent = "₦ 0";
        }
    }

   // --- QUANTITY UPDATES ---
document.querySelectorAll('.increment-button, .decrement-button').forEach(button => {
    button.addEventListener('click', function() {
        const productId = this.dataset.productId;
        const action = this.classList.contains('increment-button') ? 'increment' : 'decrement';
        const quantitySpan = this.parentElement.querySelector('.item-quantity');
        const itemSumPriceDisplay = this.closest('.cart-item').querySelector('.item-sum-price');

        // Toggle loading state
        this.classList.add('loading');
        this.disabled = true;

        updateCart(action, productId, this, quantitySpan, itemSumPriceDisplay);
    });
});

function updateCart(action, productId, buttonElement, quantitySpan, itemSumPriceDisplay) {
    fetch('/cart/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
        body: JSON.stringify({ action: action, product_id: productId })
    })
    .then(response => response.json())
    .then(data => {
        // Remove loading state
        buttonElement.classList.remove('loading');
        buttonElement.disabled = false;

        if (data.status === 'success') {
            quantitySpan.textContent = data.new_quantity;
            itemSumPriceDisplay.textContent = `₦${data.new_item_sum_price}`;
            totalPriceDisplay.textContent = `₦ ${data.new_total_price}`;

            const checkoutBtnPrice = document.getElementById('checkout-btn-price');
            if (checkoutBtnPrice) {
                checkoutBtnPrice.textContent = `₦ ${data.new_total_price}`;
            }
            
            if (typeof fetchCartCount === "function") fetchCartCount(); 

            if (data.new_quantity === 0) {
                buttonElement.closest('.cart-item').remove();
                checkEmptyCart();
            }
        }
        if(data.status==='error'){
        showAlert(data.message,'error');
      }
    })
      
    .catch(error => {
        buttonElement.classList.remove('loading');
        buttonElement.disabled = false;
        console.error('Error:', error);
    });
}

 
    // --- DELETE ITEM ---
    function delete_cart_item(productId) {
        showLoading();
        fetch('/delete_cart_item/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
            body: JSON.stringify({ product_id: productId })
        })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            if (data.status === 'success') {
                document.querySelector(`.cart-item[data-product-id="${productId}"]`).remove();
                totalPriceDisplay.textContent = `₦ ${data.new_total_price || 0}`;
                const checkoutBtnPrice = document.getElementById('checkout-btn-price');

                if (checkoutBtnPrice) {
                    checkoutBtnPrice.textContent = `₦ ${data.new_total_price || 0}`;
                }
                fetchCartCount();
                checkEmptyCart();
                showAlert('Item removed!', 'success');
                location.reload();
            }
        });
    }

    // --- CLEAR CART ---
    function clearCart() {
        showLoading();
        fetch('/clear_cart/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
        })
        .then(res => res.json())
        .then(data => {
            hideLoading();
            if (data.status === 'success') {
                location.reload(); 
            }
        });
    }

    // --- PAYMENT MODAL ---
    document.getElementById('payment-options-button').addEventListener('click', (e) => {
    e.preventDefault();
    const form = document.getElementById('checkout-form');

    // 1. Check if the cart is empty
    const cartItems = document.querySelectorAll('.cart-item');
    if (cartItems.length === 0) {
        showAlert('Your cart is empty!', 'error');
        return;
    }

    // 2. Use the browser's built-in validation (it's better than areFormFieldsFilled)
    if (!form.checkValidity()) {
        form.reportValidity(); // This highlights the specific empty input (e.g., "Please fill out this field")
        return;
    }

    // 3. If everything is fine, show the popup
    popupContainer.style.display = 'flex';
});

    document.getElementById('close-popup').onclick = () => popupContainer.style.display = 'none';

    document.getElementById('paystack-pay').onclick = function() {
        showLoading();
        const formData = {
            name: document.getElementById('name').value,
            address: document.getElementById('address').value,
            state: document.getElementById('state').value,
            country: document.getElementById('country').value,
            email: document.getElementById('email').value,
            phone_number: document.getElementById('phone_number').value,
            description: document.getElementById('description').value,
            payment_option: "Paystack"
        };

        fetch('/initialize_payment/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
            body: JSON.stringify(formData),
        })
        .then(res => res.json())
        .then(data => {
            hideLoading();
            if (data.status === 'success') {
                let handler = PaystackPop.setup({
                    key: data.public_key,
                    email: data.email,
                    amount: data.amount * 100,
                    currency: 'NGN',
                    ref: data.transaction_id,
                    callback: (res) => window.location.href = '/confirm_order_payment/' + data.transaction_id
                });
                handler.openIframe();
            }
        });
    };
</script>

<script src="https://js.paystack.co/v1/inline.js"></script>
{% endblock content %}